<!DOCTYPE html>
<html lang="es-BO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECIBO TRÉBOL | Sistema Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* Variables de color - Sistema dual claro/oscuro */
        :root {
            --modo: 'claro';
            
            /* Colores modo claro */
            --verde-trebol-claro: #228B22;
            --verde-trebol-oscuro-claro: #1A6B1A;
            --verde-trebol-suave-claro: #90EE90;
            --verde-trebol-palido-claro: #E8F5E8;
            --oro-claro: #FFD700;
            --oro-oscuro-claro: #DAA520;
            --fondo-claro: #f8fff8;
            --fondo-panel-claro: #FFFFFF;
            --texto-principal-claro: #2C3E50;
            --texto-secundario-claro: #5D6D7E;
            --borde-claro: #E0E0E0;
            --sombra-claro: 0 8px 30px rgba(34, 139, 34, 0.15);
            
            /* Colores modo oscuro */
            --verde-trebol-oscuro: #32CD32;
            --verde-trebol-oscuro-oscuro: #228B22;
            --verde-trebol-suave-oscuro: #006400;
            --verde-trebol-palido-oscuro: #0A2F0A;
            --oro-oscuro: #FFD700;
            --oro-oscuro-oscuro: #FFA500;
            --fondo-oscuro: #0A1F0A;
            --fondo-panel-oscuro: #1A3A1A;
            --texto-principal-oscuro: #E8F5E8;
            --texto-secundario-oscuro: #90EE90;
            --borde-oscuro: #2E7D32;
            --sombra-oscuro: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        /* Aplicar variables según modo */
        body.modo-claro {
            --verde-trebol: var(--verde-trebol-claro);
            --verde-trebol-oscuro: var(--verde-trebol-oscuro-claro);
            --verde-trebol-suave: var(--verde-trebol-suave-claro);
            --verde-trebol-palido: var(--verde-trebol-palido-claro);
            --oro: var(--oro-claro);
            --oro-oscuro: var(--oro-oscuro-claro);
            --fondo: var(--fondo-claro);
            --fondo-panel: var(--fondo-panel-claro);
            --texto-principal: var(--texto-principal-claro);
            --texto-secundario: var(--texto-secundario-claro);
            --borde: var(--borde-claro);
            --sombra: var(--sombra-claro);
            --modo: 'claro';
        }

        body.modo-oscuro {
            --verde-trebol: var(--verde-trebol-oscuro);
            --verde-trebol-oscuro: var(--verde-trebol-oscuro-oscuro);
            --verde-trebol-suave: var(--verde-trebol-suave-oscuro);
            --verde-trebol-palido: var(--verde-trebol-palido-oscuro);
            --oro: var(--oro-oscuro);
            --oro-oscuro: var(--oro-oscuro-oscuro);
            --fondo: var(--fondo-oscuro);
            --fondo-panel: var(--fondo-panel-oscuro);
            --texto-principal: var(--texto-principal-oscuro);
            --texto-secundario: var(--texto-secundario-oscuro);
            --borde: var(--borde-oscuro);
            --sombra: var(--sombra-oscuro);
            --modo: 'oscuro';
        }

        /* Variables comunes */
        :root {
            --radio: 12px;
            --radio-pequeno: 8px;
            --fuente-titulos: 'Montserrat', sans-serif;
            --fuente-texto: 'Poppins', sans-serif;
            --transicion: all 0.3s ease;
            --sombra-intensa: 0 15px 40px rgba(34, 139, 34, 0.25);
        }

        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: var(--fuente-texto);
            line-height: 1.6;
            color: var(--texto-principal);
            background-color: var(--fondo);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .contenedor {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* Interruptor modo claro/oscuro */
        .modo-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .modo-boton {
            width: 60px;
            height: 30px;
            background: var(--verde-trebol);
            border-radius: 15px;
            border: 2px solid var(--oro);
            cursor: pointer;
            position: relative;
            transition: var(--transicion);
            display: flex;
            align-items: center;
            padding: 0 5px;
        }

        .modo-icono {
            width: 20px;
            height: 20px;
            background: var(--oro);
            border-radius: 50%;
            position: absolute;
            left: 5px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--verde-trebol);
            font-size: 12px;
        }

        body.modo-oscuro .modo-icono {
            transform: translateX(30px);
        }

        /* Encabezado principal */
        .encabezado-principal {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, var(--verde-trebol) 0%, var(--verde-trebol-oscuro) 100%);
            border-radius: var(--radio);
            color: white;
            box-shadow: var(--sombra);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--borde);
        }

        .logo-titulo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .logo-circular {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid var(--oro);
        }

        .logo-circular img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .titulo-principal {
            font-family: var(--fuente-titulos);
            font-size: 2.5rem;
            margin: 0;
            color: white;
        }

        .subtitulo {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 15px;
            color: white;
        }

        .info-lugar {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
            color: white;
        }

        /* Layout principal */
        .contenido-principal {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 1200px) {
            .contenido-principal {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Paneles */
        .panel {
            background: var(--fondo-panel);
            border-radius: var(--radio);
            padding: 25px;
            box-shadow: var(--sombra);
            border: 1px solid var(--borde);
            transition: var(--transicion);
        }

        .panel h2 {
            color: var(--verde-trebol);
            margin-bottom: 25px;
            font-size: 1.6rem;
            font-family: var(--fuente-titulos);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--borde);
        }

        /* Formulario */
        .grupo-formulario {
            margin-bottom: 20px;
        }

        .grupo-formulario label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--verde-trebol);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .campo-obligatorio::after {
            content: " *";
            color: #E74C3C;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--borde);
            border-radius: var(--radio-pequeno);
            font-family: var(--fuente-texto);
            font-size: 16px;
            background-color: var(--fondo-panel);
            color: var(--texto-principal);
            transition: var(--transicion);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--verde-trebol);
            box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .campo-monto {
            position: relative;
        }

        .simbolo-monto {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--verde-trebol);
            font-weight: bold;
            background: var(--verde-trebol-palido);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--verde-trebol-suave);
        }

        .campo-monto input {
            padding-left: 70px;
            font-size: 18px;
            font-weight: 600;
        }

        /* Fecha automática */
        .fecha-auto {
            background-color: var(--verde-trebol-palido);
            padding: 12px 15px;
            border-radius: var(--radio-pequeno);
            border: 1px solid var(--verde-trebol-suave);
            font-weight: 600;
            color: var(--verde-trebol);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Sello digital */
        .sello-digital {
            background: var(--verde-trebol-palido);
            border-radius: var(--radio-pequeno);
            padding: 20px;
            text-align: center;
            border: 2px dashed var(--verde-trebol);
            margin-top: 10px;
        }

        .sello-imagen {
            max-width: 180px;
            margin: 0 auto 10px;
        }

        /* Botones */
        .botones-accion {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .boton {
            padding: 15px 25px;
            border: none;
            border-radius: var(--radio-pequeno);
            font-family: var(--fuente-titulos);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transicion);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 180px;
        }

        .boton-primario {
            background: linear-gradient(135deg, var(--verde-trebol) 0%, var(--verde-trebol-oscuro) 100%);
            color: white;
        }

        .boton-primario:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(34, 139, 34, 0.3);
        }

        .boton-secundario {
            background: linear-gradient(135deg, var(--oro) 0%, var(--oro-oscuro) 100%);
            color: var(--texto-principal);
        }

        .boton-secundario:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .boton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Recibo A4 - UNA SOLA PÁGINA */
        .recibo {
            background: white;
            width: 794px; /* Ancho exacto A4 en pixels a 96dpi */
            min-height: 1123px; /* Alto exacto A4 en pixels a 96dpi */
            margin: 0 auto;
            padding: 40px 50px;
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            position: relative;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Encabezado del recibo */
        .recibo-encabezado {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000;
        }

        .info-emisor {
            flex: 1;
            font-size: 12px;
        }

        .info-emisor h3 {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .logo-recibo {
            width: 100px;
            text-align: center;
        }

        .logo-recibo img {
            max-width: 80px;
            height: auto;
        }

        /* Título del recibo */
        .titulo-recibo {
            text-align: center;
            font-size: 28px;
            margin: 20px 0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Número de recibo */
        .numero-recibo {
            text-align: right;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 14px;
            padding: 8px 15px;
            background: #f0f0f0;
            display: inline-block;
            float: right;
            border: 1px solid #ccc;
        }

        /* Información del destinatario */
        .destinatario-info {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #000;
            font-size: 13px;
        }

        .destinatario-info h4 {
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Monto total */
        .monto-total {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin: 30px 0;
            padding: 25px;
            border: 3px solid #000;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
        }

        .monto-letras {
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }

        /* Fecha */
        .fecha-emision {
            margin: 25px 0;
            font-size: 13px;
            color: #555;
        }

        /* Área de autorización - AHORA CON CÓDIGO QR */
        .autorizacion {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid #000;
            position: absolute;
            bottom: 50px;
            left: 50px;
            right: 50px;
        }

        .sellos-contenedor {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .sello-firma {
            text-align: center;
            width: 200px;
        }

        .sello-firma img {
            max-width: 120px;
            margin-bottom: 10px;
        }

        .qr-contenedor {
            text-align: center;
            width: 150px;
        }

        #qr-canvas {
            width: 120px !important;
            height: 120px !important;
            margin: 0 auto 10px;
            border: 1px solid #ccc;
            padding: 5px;
            background: white;
        }

        .qr-texto {
            font-size: 11px;
            color: #555;
        }

        /* Pie del recibo */
        .pie-recibo {
            position: absolute;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }

        .lugar-emision {
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Notificaciones */
        .notificacion {
            padding: 15px;
            border-radius: var(--radio-pequeno);
            margin-top: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .notificacion-exito {
            background: rgba(39, 174, 96, 0.1);
            color: #27AE60;
            border-left: 4px solid #27AE60;
        }

        .notificacion-error {
            background: rgba(231, 76, 60, 0.1);
            color: #E74C3C;
            border-left: 4px solid #E74C3C;
        }

        /* Errores */
        .mensaje-error {
            color: #E74C3C;
            font-size: 13px;
            margin-top: 5px;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .campo-invalido {
            border-color: #E74C3C !important;
            background-color: rgba(231, 76, 60, 0.05) !important;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .recibo {
                width: 100%;
                padding: 30px;
                min-height: auto;
            }
            
            .contenido-principal {
                grid-template-columns: 1fr;
            }
            
            .encabezado-principal {
                padding: 20px;
            }
            
            .titulo-principal {
                font-size: 2rem;
            }
            
            .panel {
                padding: 20px;
            }
            
            .boton {
                min-width: 100%;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .recibo {
                padding: 20px;
            }
            
            .recibo-encabezado {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-recibo {
                margin: 15px auto;
            }
            
            .sellos-contenedor {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .sello-firma, .qr-contenedor {
                width: 100%;
            }
            
            .autorizacion {
                position: relative;
                bottom: auto;
                margin-top: 30px;
            }
        }

        /* Modo impresión */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .recibo, .recibo * {
                visibility: visible;
            }
            
            .recibo {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 100%;
                margin: 0;
                padding: 30px;
                box-shadow: none;
                border: none;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* Utilidades */
        .cargando {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .texto-centro {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Área para accesibilidad */
        .aria-live {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body class="modo-claro">
    <!-- Interruptor modo claro/oscuro -->
    <div class="modo-toggle no-print">
        <div class="modo-boton" id="modo-toggle">
            <div class="modo-icono">
                <i class="fas fa-sun"></i>
            </div>
        </div>
    </div>
    
    <div class="contenedor">
        <!-- Encabezado principal -->
        <header class="encabezado-principal no-print">
            <div class="logo-titulo">
                <div class="logo-circular">
                    <img src="assets/logo.png" alt="Logo Recibo Trébol" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"45\" fill=\"%23228B22\"/><path d=\"M50,25 C60,25 68,30 73,38 C78,46 78,56 73,64 C68,72 60,77 50,77 C40,77 32,72 27,64 C22,56 22,46 27,38 C32,30 40,25 50,25 Z M50,35 C55,35 60,38 63,43 C66,48 66,54 63,59 C60,64 55,67 50,67 C45,67 40,64 37,59 C34,54 34,48 37,43 C40,38 45,35 50,35 Z\" fill=\"%23FFFFFF\"/></svg>">
                </div>
                <h1 class="titulo-principal">RECIBO TRÉBOL</h1>
            </div>
            
            <p class="subtitulo">Sistema profesional de emisión de recibos - Formato A4 de una sola página</p>
            
            <div class="info-lugar">
                <i class="fas fa-map-marker-alt"></i>
                <span>YACUIBA - TARIJA - BOLIVIA</span>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="contenido-principal">
            <!-- Panel del formulario -->
            <section class="panel no-print" id="panel-formulario">
                <h2><i class="fas fa-edit"></i> Datos del Recibo</h2>
                
                <form id="formulario-recibo">
                    <!-- Nombre/Razón Social -->
                    <div class="grupo-formulario">
                        <label for="nombre" class="campo-obligatorio">
                            <i class="fas fa-user-tie"></i> Nombre o razón social
                        </label>
                        <input type="text" id="nombre" placeholder="Ej: Juan Pérez Morales o Empresa S.A.">
                        <div class="mensaje-error" id="error-nombre">
                            <i class="fas fa-exclamation-circle"></i> Este campo es obligatorio
                        </div>
                    </div>

                    <!-- CI/NIT -->
                    <div class="grupo-formulario">
                        <label for="ci-nit">
                            <i class="fas fa-id-card"></i> CI/NIT
                        </label>
                        <input type="text" id="ci-nit" placeholder="Ej: 1234567 SC o 123456789">
                    </div>

                    <!-- Ítem -->
                    <div class="grupo-formulario">
                        <label for="item" class="campo-obligatorio">
                            <i class="fas fa-tags"></i> Ítem de servicio
                        </label>
                        <select id="item">
                            <option value="">Seleccione un ítem</option>
                            <option value="ALQUILER DE VEHÍCULO">ALQUILER DE VEHÍCULO</option>
                            <option value="ALQUILER DE ALMACÉN">ALQUILER DE ALMACÉN</option>
                            <option value="ALQUILER DE VIVIENDA">ALQUILER DE VIVIENDA</option>
                            <option value="SERVICIO DE METALURGIA">SERVICIO DE METALURGIA</option>
                            <option value="SERVICIO DE CONSTRUCCIÓN">SERVICIO DE CONSTRUCCIÓN</option>
                            <option value="CONSULTORÍA TÉCNICA">CONSULTORÍA TÉCNICA</option>
                            <option value="VENTA DE MATERIALES">VENTA DE MATERIALES</option>
                            <option value="VARIOS">VARIOS</option>
                        </select>
                        <div class="mensaje-error" id="error-item">
                            <i class="fas fa-exclamation-circle"></i> Debe seleccionar un ítem
                        </div>
                    </div>

                    <!-- Detalle -->
                    <div class="grupo-formulario">
                        <label for="detalle">
                            <i class="fas fa-align-left"></i> Detalle del servicio
                        </label>
                        <textarea id="detalle" placeholder="Descripción detallada del servicio..."></textarea>
                    </div>

                    <!-- Monto - SIN LÍMITES -->
                    <div class="grupo-formulario">
                        <label for="monto" class="campo-obligatorio">
                            <i class="fas fa-money-bill-wave"></i> Monto en Bolivianos (Bs)
                        </label>
                        <div class="campo-monto">
                            <span class="simbolo-monto">Bs</span>
                            <input type="text" id="monto" placeholder="0.00" inputmode="decimal">
                        </div>
                        <div class="mensaje-error" id="error-monto">
                            <i class="fas fa-exclamation-circle"></i> Ingrese un monto válido mayor a 0
                        </div>
                    </div>

                    <!-- Fecha automática -->
                    <div class="grupo-formulario">
                        <label>
                            <i class="fas fa-calendar-check"></i> Fecha de emisión (Bolivia)
                        </label>
                        <div class="fecha-auto">
                            <i class="fas fa-clock"></i>
                            <span id="fecha-actual">Cargando fecha y hora...</span>
                        </div>
                        <input type="hidden" id="fecha-iso">
                        <input type="hidden" id="fecha-texto">
                    </div>

                    <!-- Sello Digital -->
                    <div class="grupo-formulario">
                        <label>
                            <i class="fas fa-stamp"></i> Sello Digital Autorizado
                        </label>
                        <div class="sello-digital">
                            <img src="assets/sello.png" alt="Sello digital autorizado" class="sello-imagen" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 200 200\"><circle cx=\"100\" cy=\"100\" r=\"90\" fill=\"%23f8fff8\" stroke=\"%23228B22\" stroke-width=\"4\"/><circle cx=\"100\" cy=\"100\" r=\"70\" fill=\"%23FFFFFF\" stroke=\"%23FFD700\" stroke-width=\"3\"/><text x=\"100\" y=\"80\" text-anchor=\"middle\" fill=\"%23228B22\" font-size=\"18\" font-weight=\"bold\">SELLO OFICIAL</text><text x=\"100\" y=\"110\" text-anchor=\"middle\" fill=\"%23228B22\" font-size=\"14\">RECIBO TRÉBOL</text><text x=\"100\" y=\"135\" text-anchor=\"middle\" fill=\"%23228B22\" font-size=\"12\">YACUIBA - BOLIVIA</text></svg>'">
                            <div class="texto-centro">
                                <i class="fas fa-check-circle"></i> Sello digital autorizado
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="botones-accion">
                        <button type="button" id="generar-recibo" class="boton boton-primario">
                            <i class="fas fa-file-invoice-dollar"></i> Generar Recibo
                        </button>
                        <button type="button" id="descargar-pdf" class="boton boton-secundario" disabled>
                            <i class="fas fa-file-pdf"></i> Descargar PDF
                        </button>
                        <button type="button" id="imprimir-recibo" class="boton" style="background: #6c757d; color: white;" disabled>
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </form>

                <!-- Notificaciones -->
                <div id="notificacion-exito" class="notificacion notificacion-exito">
                    <i class="fas fa-check-circle"></i>
                    <span>¡Recibo generado exitosamente! Ya puede descargar el PDF.</span>
                </div>
                
                <div id="notificacion-error" class="notificacion notificacion-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="mensaje-error-texto"></span>
                </div>
            </section>

            <!-- Panel del recibo generado -->
            <section class="panel" id="panel-recibo">
                <h2><i class="fas fa-eye"></i> Vista Previa del Recibo (Formato A4)</h2>
                <div id="contenedor-recibo" class="recibo">
                    <div class="texto-centro" style="padding: 200px 20px; color: #666;">
                        <i class="fas fa-receipt" style="font-size: 60px; margin-bottom: 20px; color: #ccc;"></i>
                        <h3 style="color: #333; margin-bottom: 15px;">Recibo en espera</h3>
                        <p>Complete el formulario para generar un recibo profesional en formato A4</p>
                    </div>
                </div>
                
                <div class="mt-20 no-print" style="text-align: center; color: var(--texto-secundario); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> El recibo está optimizado para una sola página A4
                </div>
            </section>
        </main>
    </div>

    <!-- Área para anuncios de accesibilidad -->
    <div id="aria-live" class="aria-live" aria-live="polite" aria-atomic="true"></div>

    <script>
        // Variables globales
        let numeroRecibo = parseInt(localStorage.getItem('ultimoRecibo') || '1000');
        let fechaBolivia;
        let generandoPDF = false;
        let reciboGenerado = false;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFecha();
            cargarUltimoDestinatario();
            configurarEventos();
            actualizarFechaPeriodicamente();
            inicializarModo();
            precargarImagenes();
        });

        // Precargar imágenes
        function precargarImagenes() {
            ['assets/logo.png', 'assets/sello.png'].forEach(src => {
                new Image().src = src;
            });
        }

        // Inicializar modo claro/oscuro
        function inicializarModo() {
            const modoGuardado = localStorage.getItem('modo-recibo') || 'claro';
            document.body.classList.toggle('modo-claro', modoGuardado === 'claro');
            document.body.classList.toggle('modo-oscuro', modoGuardado === 'oscuro');
            
            document.getElementById('modo-toggle').addEventListener('click', function() {
                const esModoOscuro = document.body.classList.contains('modo-oscuro');
                if (esModoOscuro) {
                    document.body.classList.remove('modo-oscuro');
                    document.body.classList.add('modo-claro');
                    localStorage.setItem('modo-recibo', 'claro');
                } else {
                    document.body.classList.remove('modo-claro');
                    document.body.classList.add('modo-oscuro');
                    localStorage.setItem('modo-recibo', 'oscuro');
                }
            });
        }

        // Configurar fecha
        function inicializarFecha() {
            const opciones = {
                timeZone: 'America/La_Paz',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            
            const ahora = new Date();
            fechaBolivia = ahora.toLocaleString('es-BO', opciones);
            const fechaISO = ahora.toISOString();
            
            document.getElementById('fecha-actual').textContent = fechaBolivia;
            document.getElementById('fecha-iso').value = fechaISO;
            document.getElementById('fecha-texto').value = ahora.toLocaleString('es-BO', {
                timeZone: 'America/La_Paz',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Actualizar fecha periódicamente
        function actualizarFechaPeriodicamente() {
            setInterval(inicializarFecha, 30000);
        }

        // Configurar eventos
        function configurarEventos() {
            // Formatear monto al escribir
            document.getElementById('monto').addEventListener('input', function(e) {
                formatearMonto(e.target);
                ocultarError('monto');
            });

            // Validar campos en tiempo real
            document.querySelectorAll('#formulario-recibo input, #formulario-recibo select').forEach(elemento => {
                elemento.addEventListener('blur', function() {
                    if (this.id && this.id !== 'ci-nit' && this.id !== 'detalle') {
                        validarCampo(this.id);
                    }
                });
            });

            // Generar recibo
            document.getElementById('generar-recibo').addEventListener('click', function() {
                if (!generandoPDF && validarFormulario()) {
                    generarRecibo();
                }
            });

            // Descargar PDF
            document.getElementById('descargar-pdf').addEventListener('click', descargarPDF);
            
            // Imprimir recibo
            document.getElementById('imprimir-recibo').addEventListener('click', function() {
                window.print();
            });
        }

        // Formatear monto (SIN LÍMITES)
        function formatearMonto(input) {
            let valor = input.value.replace(/[^0-9.]/g, '');
            valor = valor.replace(/(\..*)\./g, '$1');
            
            const partes = valor.split('.');
            if (partes.length > 1) {
                partes[1] = partes[1].slice(0, 2);
                valor = partes.join('.');
            }
            
            // Formatear con separadores de miles
            if (valor) {
                const partesEntero = valor.split('.');
                partesEntero[0] = partesEntero[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                input.value = partesEntero.join('.');
            } else {
                input.value = valor;
            }
        }

        // Validar campo
        function validarCampo(campoId) {
            const elemento = document.getElementById(campoId);
            let valido = true;
            let mensaje = '';
            
            switch(campoId) {
                case 'nombre':
                    if (!elemento.value.trim()) {
                        valido = false;
                        mensaje = 'Este campo es obligatorio';
                    }
                    break;
                    
                case 'item':
                    if (!elemento.value) {
                        valido = false;
                        mensaje = 'Debe seleccionar un ítem';
                    }
                    break;
                    
                case 'monto':
                    let valor = elemento.value.replace(/\./g, '');
                    const monto = parseFloat(valor);
                    if (!monto || isNaN(monto) || monto <= 0) {
                        valido = false;
                        mensaje = 'Ingrese un monto válido mayor a 0';
                    }
                    // SIN LÍMITE MÁXIMO - ELIMINADA LA VALIDACIÓN DE 10,000,000
                    break;
            }
            
            if (!valido) {
                mostrarError(campoId, mensaje);
            } else {
                ocultarError(campoId);
            }
            
            return valido;
        }

        // Validar formulario
        function validarFormulario() {
            const campos = ['nombre', 'item', 'monto'];
            let valido = true;
            
            for (const campo of campos) {
                if (!validarCampo(campo)) {
                    valido = false;
                }
            }
            
            if (!valido) {
                mostrarNotificacion('error', 'Hay errores en el formulario. Revise los campos marcados.');
            }
            
            return valido;
        }

        // Mostrar/ocultar errores
        function mostrarError(campo, mensaje) {
            const elemento = document.getElementById(`error-${campo}`);
            elemento.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${mensaje}`;
            elemento.style.display = 'flex';
            document.getElementById(campo).classList.add('campo-invalido');
        }

        function ocultarError(campo) {
            document.getElementById(`error-${campo}`).style.display = 'none';
            document.getElementById(campo).classList.remove('campo-invalido');
        }

        // Mostrar notificaciones
        function mostrarNotificacion(tipo, mensaje) {
            const notificacionExito = document.getElementById('notificacion-exito');
            const notificacionError = document.getElementById('notificacion-error');
            const mensajeError = document.getElementById('mensaje-error-texto');
            
            if (tipo === 'exito') {
                notificacionError.style.display = 'none';
                notificacionExito.style.display = 'flex';
                setTimeout(() => notificacionExito.style.display = 'none', 5000);
            } else {
                notificacionExito.style.display = 'none';
                notificacionError.style.display = 'flex';
                mensajeError.textContent = mensaje;
                setTimeout(() => notificacionError.style.display = 'none', 5000);
            }
        }

        // Generar código QR GRATUITO con qrcode.js
        function generarQR(datos, elementoId) {
            // Limpiar contenedor anterior
            const contenedor = document.getElementById(elementoId);
            contenedor.innerHTML = '';
            
            // Generar nuevo QR
            new QRCode(contenedor, {
                text: datos,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Generar recibo UNA SOLA PÁGINA A4
        function generarRecibo() {
            // Incrementar número de recibo
            numeroRecibo++;
            localStorage.setItem('ultimoRecibo', numeroRecibo.toString());
            
            // Obtener datos
            const nombre = escapeHTML(document.getElementById('nombre').value.trim());
            const ciNit = escapeHTML(document.getElementById('ci-nit').value.trim());
            const item = document.getElementById('item').value;
            const detalle = escapeHTML(document.getElementById('detalle').value.trim());
            let montoValor = document.getElementById('monto').value.replace(/\./g, '');
            const monto = parseFloat(montoValor);
            
            // Formatear monto
            const formateador = new Intl.NumberFormat('es-BO', {
                style: 'currency',
                currency: 'BOB',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const montoFormateado = formateador.format(monto);
            
            // Crear HTML del recibo (UNA SOLA PÁGINA A4)
            const reciboHTML = `
                <div class="numero-recibo">
                    RECIBO N°: <strong>${numeroRecibo.toString().padStart(6, '0')}</strong>
                </div>
                
                <div class="recibo-encabezado">
                    <div class="info-emisor">
                        <h3>FRANZ RAFAEL MANGUIA IÑIGUEZ</h3>
                        <p><strong>C.I.:</strong> 5.045.135</p>
                        <p><strong>Celular:</strong> 72971268</p>
                        <p><strong>Dirección:</strong> Barrio San Gerónimo</p>
                        <p><strong>Ciudad:</strong> Yacuiba - Tarija - Bolivia</p>
                    </div>
                    <div class="logo-recibo">
                        <img src="assets/logo.png" alt="Logo Recibo Trébol" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 120 120\"><circle cx=\"60\" cy=\"60\" r=\"55\" fill=\"%23228B22\"/><path d=\"M60,30 C70,30 78,35 83,43 C88,51 88,61 83,69 C78,77 70,82 60,82 C50,82 42,77 37,69 C32,61 32,51 37,43 C42,35 50,30 60,30 Z M60,40 C65,40 70,43 73,48 C76,53 76,59 73,64 C70,69 65,72 60,72 C55,72 50,69 47,64 C44,59 44,53 47,48 C50,43 55,40 60,40 Z\" fill=\"%23FFFFFF\"/></svg>'">
                    </div>
                </div>
                
                <h2 class="titulo-recibo">RECIBO</h2>
                
                <div class="destinatario-info">
                    <h4>DATOS DEL DESTINATARIO</h4>
                    <p><strong>Señor(es):</strong> ${nombre}</p>
                    ${ciNit ? `<p><strong>CI/NIT:</strong> ${ciNit}</p>` : ''}
                    <p><strong>Concepto:</strong> ${item}</p>
                    ${detalle ? `<p><strong>Detalle:</strong> ${detalle}</p>` : ''}
                </div>
                
                <div class="monto-total">
                    <div>TOTAL A PAGAR</div>
                    <div style="font-size: 36px; margin: 10px 0;">${montoFormateado}</div>
                    <div class="monto-letras">
                        ${numeroALetras(monto)} BOLIVIANOS
                    </div>
                </div>
                
                <div class="fecha-emision">
                    <p><strong>Fecha y hora de emisión:</strong> ${document.getElementById('fecha-texto').value}</p>
                    <p><strong>Zona horaria:</strong> America/La_Paz (UTC-4)</p>
                    <p><strong>ID Transacción:</strong> RT-${numeroRecibo}-${Date.now().toString().slice(-6)}</p>
                </div>
                
                <div class="autorizacion">
                    <div class="sellos-contenedor">
                        <div class="sello-firma">
                            <img src="assets/sello.png" alt="Sello oficial" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 120 120\"><circle cx=\"60\" cy=\"60\" r=\"55\" fill=\"%23f8fff8\" stroke=\"%23000000\" stroke-width=\"2\"/><circle cx=\"60\" cy=\"60\" r=\"45\" fill=\"%23FFFFFF\" stroke=\"%23000000\" stroke-width=\"2\"/><text x=\"60\" y=\"45\" text-anchor=\"middle\" fill=\"%23000000\" font-size=\"12\" font-weight=\"bold\">AUTORIZADO</text><text x=\"60\" y=\"65\" text-anchor=\"middle\" fill=\"%23000000\" font-size=\"10\">FRANZ R. MANGUIA</text><text x=\"60\" y=\"85\" text-anchor=\"middle\" fill=\"%23000000\" font-size=\"9\">CI 5.045.135</text></svg>'">
                            <div class="qr-texto">Sello y Firma del Emisor</div>
                        </div>
                        
                        <div class="qr-contenedor">
                            <div id="qr-canvas"></div>
                            <div class="qr-texto">Código QR de verificación</div>
                        </div>
                    </div>
                </div>
                
                <div class="pie-recibo">
                    <div class="lugar-emision">
                        LUGAR DE EMISIÓN: YACUIBA - TARIJA - BOLIVIA
                    </div>
                    <p><strong>Nota:</strong> Este recibo es válido para fines administrativos, legales y contables.</p>
                    <p style="margin-top: 10px; font-size: 11px;">
                        Documento generado electrónicamente - RECIBO TRÉBOL © ${new Date().getFullYear()}
                    </p>
                </div>
            `;
            
            // Mostrar recibo
            const contenedorRecibo = document.getElementById('contenedor-recibo');
            contenedorRecibo.innerHTML = reciboHTML;
            
            // Generar código QR con datos del recibo
            const datosQR = `RECIBO TRÉBOL|N°:${numeroRecibo}|MONTO:${montoFormateado}|FECHA:${document.getElementById('fecha-texto').value}|EMISOR:FRANZ MANGUIA|CI:5045135|LUGAR:YACUIBA`;
            setTimeout(() => generarQR(datosQR, 'qr-canvas'), 100);
            
            // Habilitar botones
            document.getElementById('descargar-pdf').disabled = false;
            document.getElementById('imprimir-recibo').disabled = false;
            reciboGenerado = true;
            
            // Mostrar mensaje
            mostrarNotificacion('exito', `Recibo N° ${numeroRecibo} generado exitosamente.`);
            
            // Guardar datos
            localStorage.setItem('ultimoDestinatario', nombre);
            
            // Anunciar para accesibilidad
            anunciarAccesibilidad(`Recibo número ${numeroRecibo} generado exitosamente.`);
        }

        // Descargar PDF como IMAGEN (no editable)
        function descargarPDF() {
            if (generandoPDF || !reciboGenerado) return;
            
            generandoPDF = true;
            const botonPDF = document.getElementById('descargar-pdf');
            const textoOriginal = botonPDF.innerHTML;
            
            // Mostrar carga
            botonPDF.innerHTML = '<span class="cargando"></span> Generando PDF...';
            botonPDF.disabled = true;
            
            const elemento = document.getElementById('contenedor-recibo');
            
            // Configuración para PDF de UNA PÁGINA A4 como imagen
            const opciones = {
                margin: [5, 5, 5, 5], // Márgenes mínimos
                filename: `Recibo-Trebol-${numeroRecibo}.pdf`,
                image: { 
                    type: 'jpeg', 
                    quality: 0.98
                },
                html2canvas: { 
                    scale: 2, // Escala adecuada para A4
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#FFFFFF',
                    letterRendering: true,
                    width: 794, // Ancho exacto A4
                    height: 1123, // Alto exacto A4
                    windowWidth: 794
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            };
            
            anunciarAccesibilidad('Generando PDF, por favor espere...');
            
            html2pdf().set(opciones).from(elemento).save().then(() => {
                // Restaurar botón
                botonPDF.innerHTML = textoOriginal;
                botonPDF.disabled = false;
                generandoPDF = false;
                
                mostrarNotificacion('exito', `PDF Recibo-Trebol-${numeroRecibo}.pdf descargado exitosamente.`);
                anunciarAccesibilidad(`PDF descargado exitosamente.`);
                
            }).catch(error => {
                console.error('Error:', error);
                botonPDF.innerHTML = textoOriginal;
                botonPDF.disabled = false;
                generandoPDF = false;
                
                mostrarNotificacion('error', 'Error al generar PDF. Intente nuevamente.');
            });
        }

        // Convertir número a letras
        function numeroALetras(numero) {
            const unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
            const decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
            const especiales = ['DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISEIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE'];
            const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];
            
            const entero = Math.floor(numero);
            const decimal = Math.round((numero - entero) * 100);
            
            if (entero === 0) return 'CERO';
            if (entero === 1) return 'UN';
            if (entero === 100) return 'CIEN';
            
            let resultado = '';
            
            // Miles
            if (entero >= 1000) {
                const miles = Math.floor(entero / 1000);
                if (miles === 1) {
                    resultado += 'MIL ';
                } else {
                    resultado += numeroALetras(miles) + ' MIL ';
                }
            }
            
            // Centenas
            const resto = entero % 1000;
            if (resto >= 100) {
                const centena = Math.floor(resto / 100);
                resultado += centenas[centena] + ' ';
            }
            
            // Decenas y unidades
            const decenaUnidad = resto % 100;
            if (decenaUnidad >= 10 && decenaUnidad <= 19) {
                resultado += especiales[decenaUnidad - 10] + ' ';
            } else {
                if (decenaUnidad >= 20) {
                    const decena = Math.floor(decenaUnidad / 10);
                    resultado += decenas[decena];
                    const unidad = decenaUnidad % 10;
                    if (unidad > 0) {
                        resultado += ' Y ' + unidades[unidad];
                    }
                    resultado += ' ';
                } else if (decenaUnidad > 0) {
                    resultado += unidades[decenaUnidad] + ' ';
                }
            }
            
            resultado = resultado.trim();
            
            // Decimales
            if (decimal > 0) {
                resultado += ' CON ' + decimal.toString().padStart(2, '0') + '/100';
            }
            
            return resultado + ' BOLIVIANOS';
        }

        // Cargar último destinatario
        function cargarUltimoDestinatario() {
            const ultimoDestinatario = localStorage.getItem('ultimoDestinatario');
            if (ultimoDestinatario) {
                document.getElementById('nombre').value = ultimoDestinatario;
            }
        }

        // Sanitizar HTML
        function escapeHTML(texto) {
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        // Anuncios accesibilidad
        function anunciarAccesibilidad(mensaje) {
            const liveRegion = document.getElementById('aria-live');
            liveRegion.textContent = mensaje;
            setTimeout(() => liveRegion.textContent = '', 3000);
        }
    </script>
</body>
</html>
